<!DOCTYPE html>

<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizzatore Quote Sportive</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        padding: 20px;
    }

    h1 {
        color: #667eea;
        text-align: center;
        margin-bottom: 10px;
        font-size: 2em;
    }

    .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 20px;
        font-size: 0.9em;
    }

    .info-box {
        background: #f0f4ff;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        border-left: 5px solid #667eea;
        font-size: 0.9em;
    }

    .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    select, button {
        padding: 12px 20px;
        border: 2px solid #667eea;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
    }

    select {
        flex: 1;
        min-width: 200px;
        background: white;
    }

    button {
        background: #667eea;
        color: white;
        font-weight: bold;
        min-width: 150px;
        transition: all 0.3s;
    }

    button:hover {
        background: #5568d3;
        transform: translateY(-2px);
    }

    button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }

    .api-usage {
        text-align: center;
        padding: 10px;
        background: #fff7ed;
        border-radius: 10px;
        color: #ea580c;
        font-weight: bold;
        margin-bottom: 20px;
        font-size: 0.9em;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #667eea;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .error {
        background: #fee;
        border: 2px solid #f66;
        border-radius: 10px;
        padding: 20px;
        color: #c33;
        text-align: center;
        margin: 20px 0;
    }

    .match-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
        border: 2px solid #e0e7ff;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s;
    }

    .match-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
    }

    .match-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e0e7ff;
        flex-wrap: wrap;
        gap: 10px;
    }

    .match-teams {
        font-size: 1.3em;
        font-weight: bold;
        color: #333;
    }

    .match-date {
        color: #666;
        font-size: 0.85em;
        margin-top: 5px;
    }

    .badge {
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9em;
        white-space: nowrap;
    }

    .badge-strong {
        background: #10b981;
        color: white;
    }

    .badge-moderate {
        background: #f59e0b;
        color: white;
    }

    .odds-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin: 15px 0;
    }

    .odd-item {
        background: white;
        padding: 12px;
        border-radius: 8px;
        border: 2px solid #e0e7ff;
        text-align: center;
    }

    .odd-item.recommended {
        border-color: #10b981;
        background: #f0fdf4;
    }

    .odd-label {
        font-size: 0.8em;
        color: #666;
        margin-bottom: 5px;
    }

    .odd-value {
        font-size: 1.5em;
        font-weight: bold;
        color: #333;
    }

    .odd-change {
        font-size: 0.85em;
        margin-top: 5px;
        font-weight: bold;
        color: #10b981;
    }

    .advice {
        background: #f0fdf4;
        border: 2px solid #10b981;
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
    }

    .advice-title {
        color: #10b981;
        font-weight: bold;
        margin-bottom: 8px;
        font-size: 1.1em;
    }

    .advice-text {
        color: #333;
        line-height: 1.6;
        font-size: 0.9em;
    }

    @media (max-width: 768px) {
        .container {
            padding: 15px;
        }
        
        h1 {
            font-size: 1.5em;
        }
        
        .match-teams {
            font-size: 1.1em;
        }
        
        .controls {
            flex-direction: column;
        }
        
        select, button {
            width: 100%;
        }
    }
</style>
```

</head>
<body>
    <div class="container">
        <h1>‚öΩ Analizzatore Quote Sportive</h1>
        <p class="subtitle">Trova le migliori opportunit√† di scommessa</p>

```
    <div class="info-box">
        <strong>‚ÑπÔ∏è Come funziona:</strong> L'app analizza le variazioni delle quote tra bookmaker e suggerisce le 3 partite con le migliori opportunit√†.
    </div>

    <div class="controls">
        <select id="sportSelect">
            <option value="soccer_italy_serie_a">Serie A</option>
            <option value="soccer_spain_la_liga">La Liga</option>
            <option value="soccer_epl">Premier League</option>
            <option value="soccer_germany_bundesliga">Bundesliga</option>
            <option value="soccer_france_ligue_one">Ligue 1</option>
            <option value="soccer_uefa_champs_league">Champions League</option>
        </select>
        <button id="analyzeBtn" onclick="analyzeMatches()">üîç Analizza Partite</button>
    </div>

    <div id="apiUsage" class="api-usage">
        Richieste rimanenti: <span id="remainingRequests">500</span> / 500
    </div>

    <div id="results"></div>
</div>

<script>
    let requestsUsed = parseInt(localStorage.getItem('requestsUsed') || '0');
    
    function updateApiUsage() {
        document.getElementById('remainingRequests').textContent = 500 - requestsUsed;
    }

    async function analyzeMatches() {
        if (requestsUsed >= 500) {
            showError('Hai esaurito i 500 crediti mensili. Riprova il mese prossimo.');
            return;
        }

        const sport = document.getElementById('sportSelect').value;
        const btn = document.getElementById('analyzeBtn');
        const results = document.getElementById('results');

        btn.disabled = true;
        results.innerHTML = '<div class="loading"><div class="spinner"></div><p>Caricamento dati...</p></div>';

        try {
            const response = await fetch(`/api/odds?sport=${sport}`);
            
            if (!response.ok) {
                throw new Error(`Errore ${response.status}`);
            }

            const data = await response.json();
            
            if (!data || data.length === 0) {
                showError('Nessuna partita disponibile. Prova un altro campionato.');
                return;
            }

            const analyzed = analyzeOddsChanges(data);
            displayRecommendations(analyzed);
            
            requestsUsed++;
            localStorage.setItem('requestsUsed', requestsUsed.toString());
            updateApiUsage();

        } catch (error) {
            showError(`Errore: ${error.message}. Verifica che il server sia attivo.`);
        } finally {
            btn.disabled = false;
        }
    }

    function analyzeOddsChanges(matches) {
        const analyzed = [];

        for (const match of matches) {
            if (!match.bookmakers || match.bookmakers.length === 0) continue;

            const allOdds = [];
            
            for (const bookmaker of match.bookmakers) {
                const h2hMarket = bookmaker.markets.find(m => m.key === 'h2h');
                if (h2hMarket) {
                    allOdds.push({
                        bookmaker: bookmaker.title,
                        outcomes: h2hMarket.outcomes
                    });
                }
            }

            if (allOdds.length < 2) continue;

            const avgOdds = calculateAverageOdds(allOdds);
            const variation = calculateVariation(allOdds);

            analyzed.push({
                match: match,
                avgOdds: avgOdds,
                variation: variation,
                score: calculateScore(variation, avgOdds)
            });
        }

        analyzed.sort((a, b) => b.score - a.score);
        return analyzed.slice(0, 3);
    }

    function calculateAverageOdds(allOdds) {
        const sums = {};
        const counts = {};

        for (const bookmaker of allOdds) {
            for (const outcome of bookmaker.outcomes) {
                if (!sums[outcome.name]) {
                    sums[outcome.name] = 0;
                    counts[outcome.name] = 0;
                }
                sums[outcome.name] += outcome.price;
                counts[outcome.name]++;
            }
        }

        const avgs = {};
        for (const name in sums) {
            avgs[name] = sums[name] / counts[name];
        }

        return avgs;
    }

    function calculateVariation(allOdds) {
        const variations = {};

        for (const bookmaker of allOdds) {
            for (const outcome of bookmaker.outcomes) {
                if (!variations[outcome.name]) {
                    variations[outcome.name] = { min: outcome.price, max: outcome.price };
                }
                variations[outcome.name].min = Math.min(variations[outcome.name].min, outcome.price);
                variations[outcome.name].max = Math.max(variations[outcome.name].max, outcome.price);
            }
        }

        const result = {};
        for (const name in variations) {
            const change = ((variations[name].max - variations[name].min) / variations[name].max) * 100;
            result[name] = {
                change: change,
                min: variations[name].min,
                max: variations[name].max
            };
        }

        return result;
    }

    function calculateScore(variation, avgOdds) {
        let score = 0;
        for (const outcome in variation) {
            score += variation[outcome].change * avgOdds[outcome];
        }
        return score;
    }

    function displayRecommendations(matches) {
        const results = document.getElementById('results');
        
        if (matches.length === 0) {
            results.innerHTML = '<div class="error">Nessuna opportunit√† trovata.</div>';
            return;
        }

        let html = '';

        matches.forEach((item, index) => {
            const match = item.match;
            const homeTeam = match.home_team;
            const awayTeam = match.away_team;
            const date = new Date(match.commence_time).toLocaleString('it-IT');

            const bestOutcome = Object.keys(item.variation).reduce((a, b) => 
                item.variation[a].change > item.variation[b].change ? a : b
            );

            const changePercent = item.variation[bestOutcome].change.toFixed(1);
            const isStrong = item.variation[bestOutcome].change > 10;

            let outcomeText = bestOutcome === homeTeam ? '1 (Vittoria Casa)' :
                            bestOutcome === awayTeam ? '2 (Vittoria Trasferta)' : 'X (Pareggio)';

            html += `
                <div class="match-card">
                    <div class="match-header">
                        <div>
                            <div class="match-teams">${homeTeam} vs ${awayTeam}</div>
                            <div class="match-date">üìÖ ${date}</div>
                        </div>
                        <span class="badge ${isStrong ? 'badge-strong' : 'badge-moderate'}">
                            Top #${index + 1}
                        </span>
                    </div>

                    <div class="odds-row">
            `;

            for (const outcome in item.avgOdds) {
                const isRecommended = outcome === bestOutcome;
                const change = item.variation[outcome].change;
                const avgOdd = item.avgOdds[outcome].toFixed(2);
                
                let label = outcome === homeTeam ? '1Ô∏è‚É£ Casa' :
                          outcome === awayTeam ? '2Ô∏è‚É£ Trasferta' : '‚ùå Pareggio';

                html += `
                    <div class="odd-item ${isRecommended ? 'recommended' : ''}">
                        <div class="odd-label">${label}</div>
                        <div class="odd-value">${avgOdd}</div>
                        <div class="odd-change">Var: ${change.toFixed(1)}%</div>
                    </div>
                `;
            }

            html += `
                    </div>

                    <div class="advice">
                        <div class="advice-title">üí° Consiglio</div>
                        <div class="advice-text">
                            <strong>Punta su: ${outcomeText}</strong><br>
                            Quota media: <strong>${item.avgOdds[bestOutcome].toFixed(2)}</strong><br>
                            Variazione: <strong>${changePercent}%</strong><br>
                            <span style="font-size: 0.85em;">Alta variazione = disaccordo tra bookmaker = opportunit√† di valore</span>
                        </div>
                    </div>
                </div>
            `;
        });

        results.innerHTML = html;
    }

    function showError(message) {
        document.getElementById('results').innerHTML = `<div class="error">${message}</div>`;
    }

    updateApiUsage();
</script>
```

</body>
</html>
